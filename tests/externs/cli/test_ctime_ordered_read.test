#!/bin/bash

#
#  All rights reserved (c) 2014-2025 CEA/DAM.
#
#  This file is part of Phobos.
#
#  Phobos is free software: you can redistribute it and/or modify it under
#  the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation, either version 2.1 of the Licence, or
#  (at your option) any later version.
#
#  Phobos is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public License
#  along with Phobos. If not, see <http://www.gnu.org/licenses/>.
#

#
# Test that the phobos client sets the priority of a read request from the ctime
#

test_dir=$(dirname $(readlink -e $0))
. $test_dir/test_env.sh
. $test_dir/setup_db.sh
. $test_dir/test_launch_daemon.sh
. $test_dir/tape_drive.sh
. $test_dir/utils_generation.sh


function dir_setup
{
    setup_tables

    export PHOBOS_LRS_families="dir"
    export PHOBOS_STORE_default_family="dir"
    export PHOBOS_IO_SCHED_DIR_read_algo="grouped_read"

    invoke_lrs

    setup_test_dirs
    setup_dummy_files 1 1k 1

    dir1="$DIR_TEST_IN/dir1"
    mkdir ${dir1}
    $phobos dir add ${dir1}
    $phobos dir format --unlock ${dir1}
}

function dir_cleanup
{
    waive_lrs

    cleanup_dummy_files
    cleanup_test_dirs

    drop_tables
}

# This function executes a phobos command but checks that the sent read request
# has the good priority.
function phobos_check_read_priority()
{
    local priority="$1"

    shift

    (
        tmp_gdb_script=$(mktemp)
        trap "rm $tmp_gdb_script" EXIT
        cat <<EOF > "$tmp_gdb_script"
set breakpoint pending on
break send_generated_requests
commands
    if (n_reqs > 0)
        if (requests->ralloc != 0)
            if (requests->priority != ${priority})
                echo "ERROR: priority is not set to ${priority}"
                quit 1
            end
        end
    end

    continue
end
run $phobos $*
EOF

        DEBUGINFOD_URLS="" gdb -batch -x "$tmp_gdb_script" -q python3
    )
}

function priority_from_ctime()
{
    local ctime="$1"
    local nb_usec=$(date -d "${ctime}" +"%s%6N")

    echo -${nb_usec}
}

function test_read_alloc_ctime_set
{
    $phobos put ${FILES[0]} obj || error "Put should success"

    copy_ctime=$($phobos copy list -o creation_time)
    priority=$(priority_from_ctime "${copy_ctime}")

    phobos_check_read_priority ${priority} get obj $DIR_TEST_IN/toto ||
        error "Get with priority check should success"
}

function phobos_delayed_dev_release()
{
    (
        tmp_gdb_script=$(mktemp)
        trap "rm $tmp_gdb_script" EXIT
        cat <<EOF > "$tmp_gdb_script"
set breakpoint pending on
break complete_and_transfer_release
commands
shell sleep 5
continue
end
run $phobos $*
EOF

        DEBUGINFOD_URLS="" gdb -batch -x "$tmp_gdb_script" -q python3
    )
}

function test_ordered_grouped_read
{
    $phobos put ${FILES[0]} obj1
    $phobos put ${FILES[0]} obj2
    $phobos put ${FILES[0]} obj3
    $phobos put ${FILES[0]} obj4
    export PHOBOS_IO_SCHED_DIR_ordered_grouped_read="true"
    phobos_delayed_dev_release put ${FILES[0]} obj-to-wait &
    local pid0=$!
    sleep 1
    $phobos get obj3 ${DIR_TEST_OUT}/obj3 &
    local pid3=$!
    $phobos get obj4 ${DIR_TEST_OUT}/obj4 &
    local pid4=$!
    $phobos get obj1 ${DIR_TEST_OUT}/obj1 &
    local pid1=$!
    $phobos get obj2 ${DIR_TEST_OUT}/obj2 &
    local pid2=$!

    wait $pid0
    wait $pid1
    wait $pid2
    wait $pid3
    wait $pid4

    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj1)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj2)" ]]; then
        error "Gotten obj1 must be older than obj2"
    fi
    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj1)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj3)" ]]; then
        error "Gotten obj1 must be older than obj3"
    fi
    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj1)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj4)" ]]; then
        error "Gotten obj1 must be older than obj4"
    fi

    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj2)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj3)" ]]; then
        error "Gotten obj2 must be older than obj3"
    fi
    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj2)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj4)" ]]; then
        error "Gotten obj2 must be older than obj4"
    fi

    if [[ "$(stat -c %y ${DIR_TEST_OUT}/obj3)" > \
          "$(stat -c %y ${DIR_TEST_OUT}/obj4)" ]]; then
        error "Gotten obj3 must be older than obj4"
    fi
}

# test priority to read alloc on dir
TESTS=("dir_setup; test_read_alloc_ctime_set; dir_cleanup")
TESTS+=("dir_setup; test_ordered_grouped_read; dir_cleanup")
